@model EaziLease.Models.Vehicle

@{
    ViewData["Title"] = "Vehicle Details: " + Model.RegistrationNumber;
}

<h1 class="h3 mb-4">Vehicle Details</h1>
<hr />



    <div class="col-lg-8 col-md-10 mx-auto">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0">@Model.Manufacturer @Model.Model (@Model.Year)</h4>
            </div>
            <div class="card-body">
                <dl class="row">
                    
                    <dt class="col-sm-4">@Html.DisplayNameFor(model => model.RegistrationNumber)</dt>
                    <dd class="col-sm-8">@Html.DisplayFor(model => model.RegistrationNumber)</dd>

                    <dt class="col-sm-4">@Html.DisplayNameFor(model => model.VIN)</dt>
                    <dd class="col-sm-8">@Html.DisplayFor(model => model.VIN)</dd>
                    
                    <dt class="col-sm-4">@Html.DisplayNameFor(model => model.Color)</dt>
                    <dd class="col-sm-8">@Html.DisplayFor(model => model.Color)</dd>
                    
                    <dt class="col-sm-4">@Html.DisplayNameFor(model => model.FuelType)</dt>
                    <dd class="col-sm-8">@Html.DisplayFor(model => model.FuelType)</dd>
                    
                    <dt class="col-sm-4">@Html.DisplayNameFor(model => model.Transmission)</dt>
                    <dd class="col-sm-8">@Html.DisplayFor(model => model.Transmission)</dd>

                    <dt class="col-sm-4">@Html.DisplayNameFor(model => model.Status)</dt>
                    <dd class="col-sm-8">
                        <span class="badge bg-@(Model.Status switch {
                            VehicleStatus.Available => "success",
                            VehicleStatus.Leased => "primary",
                            VehicleStatus.InMaintenance => "warning",
                            VehicleStatus.OutOfService => "danger",
                            _ => "secondary"
                        })">
                            @Html.DisplayFor(model => model.Status)
                        </span>
                    </dd>

                    <dt class="col-sm-4">@Html.DisplayNameFor(model => model.Branch)</dt>
                    <dd class="col-sm-8">@Html.DisplayFor(model => model.Branch!.Name)</dd>

                    <dt class="col-sm-4">@Html.DisplayNameFor(model => model.Supplier)</dt>
                    <dd class="col-sm-8">@Html.DisplayFor(model => model.Supplier!.Name)</dd>

                    <dt class="col-sm-4">Current Driver</dt>
                    <dd class="col-sm-8">@(Model.CurrentDriver?.FullName ?? "N/A")</dd>

                    <dt class="col-sm-4">Current Client</dt>
                    <dd class="col-sm-8">@(Model.CurrentLease?.Client?.CompanyName ?? "N/A")</dd>
                    
                    <dt class="col-sm-4">@Html.DisplayNameFor(model => model.DailyRate)</dt>
                    <dd class="col-sm-8">@Model.DailyRate.ToString("C")</dd>
                </dl>

                <h5 class="mt-4 border-top pt-3">Purchase & Service History</h5>
                <dl class="row">
                    <dt class="col-sm-4">@Html.DisplayNameFor(model => model.PurchasePrice)</dt>
                    <dd class="col-sm-8">R @Model.PurchasePrice.ToString()</dd>
                    
                    <dt class="col-sm-4">@Html.DisplayNameFor(model => model.PurchaseDate)</dt>
                    <dd class="col-sm-8">@Html.DisplayFor(model => model.PurchaseDate)</dd>
                    
                    <dt class="col-sm-4">@Html.DisplayNameFor(model => model.LastServiceDate)</dt>
                    <dd class="col-sm-8">@Html.DisplayFor(model => model.LastServiceDate)</dd>
                </dl>
                
            </div>
            @if (Model.Status != VehicleStatus.Leased && Model.Status != VehicleStatus.InMaintenance)
            {
                <a asp-action="Lease" asp-route-id="@Model.Id" class="btn btn-success btn-sm mt-2">Lease to Client</a>
            }

            @if (Model.CurrentDriver == null && Model.Status != VehicleStatus.InMaintenance)
            {
                <a asp-action="AssignDriver" asp-route-id="@Model.Id" class="btn btn-primary btn-sm mt-2">Assign Driver</a>
            }
            else
            {
                <span class="text-success">Driver: @Model?.CurrentDriver?.FullName</span>
            }   
            @if (Model?.CurrentLease != null )
            {
                @if (Model.CurrentLease != null && Model.CurrentLease.IsActive)
                {
                    <div class="mt-4">
                        <h5>Current Lease</h5>
                        <p>
                            Client: <strong>@Model.CurrentLease.Client?.CompanyName</strong><br />
                            Period: @Model.CurrentLease.LeaseStartDate.ToString("dd MMM yyyy") â€“ 
                                    @Model.CurrentLease.LeaseEndDate.ToString("dd MMM yyyy")
                        </p>

                        <!-- NEW: Extend Lease Button -->
                        <a asp-controller="Vehicles" asp-action="ExtendLease" asp-route-leaseId="@Model.CurrentLease.Id" 
                        class="btn btn-success btn-sm">
                            <i class="bi bi-calendar-plus"></i> Extend Lease
                        </a>
                    </div>
                    <a asp-controller="Vehicles" asp-action="RequestRateOverride" asp-route-vehicleId="@Model.Id" 
                         class="btn btn-info btn-sm mt-2">
                         <i class="bi bi-currency-exchange"></i> Request Rate Override
                    </a>
                }
                <hr />
                <a asp-action="EndLease" asp-route-id="@Model.Id" class="btn btn-danger btn-sm mt-2">
                    End Lease / Return Vehicle
                </a>
                
            }
            @if (Model?.CurrentDriver != null)
            {
                <a asp-action="ReturnDriver" asp-route-id="@Model.Id" class="btn btn-warning btn-sm mt-2">
                    Return Driver
                </a>
            }
            @if(Model.CurrentLease == null && Model.Status != VehicleStatus.InMaintenance)
            {
                <a asp-action="AddMaintenance" asp-route-vehicleId="@Model.Id" class="btn btn-info btn-sm mt-2">
                    <i class="bi bi-tools"></i> Record Maintenance
                </a>

            }

            <div class="card-footer text-end">
                <a asp-action="Edit" asp-route-id="@Model.Id" class="btn btn-warning">Edit</a>
                <a asp-action="Index" class="btn btn-secondary">Back to List</a>
            </div>
        </div>
    </div>
</div>


<!-- History Tabs -->
<div class="mt-5">
    <ul class="nav nav-tabs" id="historyTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="lease-tab" data-bs-toggle="tab" data-bs-target="#lease" type="button" role="tab">
                Lease History
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="assignment-tab" data-bs-toggle="tab" data-bs-target="#assignment" type="button" role="tab">
                Assignment History
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="maintenance-tab" data-bs-toggle="tab" data-bs-target="#maintenance" type="button">
                 Maintenance History
            </button>
        </li>
    </ul>

    <div class="tab-content border border-top-0 p-4 rounded-bottom" id="historyTabContent">
        <!-- Lease History Tab -->
        <div class="tab-pane fade show active" id="lease" role="tabpanel">
            @if (Model.LeaseHistory.Any())
            {
                <table class="table table-sm table-hover">
                    <thead>
                        <tr>
                            <th>Client</th>
                            <th>Start</th>
                            <th>End</th>
                            <th>Monthly Rate</th>
                            <th>Returned</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var lease in Model.LeaseHistory.OrderByDescending(l => l.LeaseStartDate))
                        {
                            <tr>
                                <td>@lease.Client.CompanyName</td>
                                <td>@lease.LeaseStartDate</td>
                                <td>@lease.LeaseEndDate</td>
                                <td>@lease.MonthlyRate:C</td>
                                <td>@(lease.ReturnDate.HasValue ? lease.ReturnDate.Value.ToString("d") : "Active")</td>
                                <td>
                                    <span class="badge @(lease.IsActive ? "bg-success" : "bg-secondary")">
                                        @(lease.IsActive ? "Active" : "Ended")
                                    </span>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
            else
            {
                <p class="text-muted">No lease history yet.</p>
            }
        </div>

        <!-- Assignment History Tab -->
        <div class="tab-pane fade" id="assignment" role="tabpanel">
            @if (Model.AssignementHistory.Any())
            {
                <table class="table table-sm table-hover">
                    <thead>
                        <tr>
                            <th>Driver</th>
                            <th>Assigned</th>
                            <th>Returned</th>
                            <th>Duration</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var ass in Model.AssignementHistory.OrderByDescending(a => a.AssignedDate))
                        {
                            <tr>
                                <td>@ass.Driver.FullName</td>
                                <td>@ass.AssignedDate</td>
                                <td>@(ass.ReturnedDate?.ToString("d") ?? "Current")</td>
                                <td>
                                    @{
                                        var end = ass.ReturnedDate ?? DateTime.SpecifyKind(DateTime.UtcNow.Date, DateTimeKind.Utc);
                                        var days = (end.Day - ass.AssignedDate.Day) + 1;
                                    }
                                    @days days
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
            else
            {
                <p class="text-muted">No assignment history yet.</p>
            }
        </div>

        <div class="tab-pane fade" id="maintenance" role="tabpanel">
    @if (Model.MaintenanceHistory.Any())
    {
        <table class="table table-sm">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Description</th>
                    <th>Cost</th>
                    <th>Mileage</th>
                    <th>Garage</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var m in Model.MaintenanceHistory.OrderByDescending(x => x.ServiceDate))
                {
                    <tr>
                        <td>@m.ServiceDate</td>
                        <td>@m.Description</td>
                        <td>@m.Cost.ToString("C")</td>
                        <td>@(m.MileageAtService?.ToString("N0") ?? "-")</td>
                        <td>@(m.GarageName ?? "-")</td>
                    </tr>
                }
            </tbody>
        </table>
    }
    else
    {
        <p class="text-muted">No maintenance records yet.</p>
    }
    </div>
    </div>
</div>

